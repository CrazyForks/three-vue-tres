var nt=Object.defineProperty,at=Object.defineProperties;var ht=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var ct=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable;var E=(i,t,e)=>t in i?nt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,A=(i,t)=>{for(var e in t||(t={}))ct.call(t,e)&&E(i,e,t[e]);if(q)for(var e of q(t))lt.call(t,e)&&E(i,e,t[e]);return i},D=(i,t)=>at(i,ht(t));var o=(i,t,e)=>(E(i,typeof t!="symbol"?t+"":t,e),e);import{cf as V,be as dt,c$ as ft,aQ as O,bd as z,bP as ut,bo as pt,b6 as mt,at as gt,a2 as wt,cJ as Mt,b3 as Tt,d2 as vt}from"./vendor.UXgcsyzV1709520134781.js";var xt=Math.PI/180,yt=180/Math.PI;function Y(i){var t=$(i[0]+1,i[2]),e=$(i[0],i[2]),r=G(i[1]+1,i[2]),s=G(i[1],i[2]);return[e,r,t,s]}function bt(i){var t=Y(i),e={type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]};return e}function $(i,t){return i/Math.pow(2,t)*360-180}function G(i,t){var e=Math.PI-2*Math.PI*i/Math.pow(2,t);return yt*Math.atan(.5*(Math.exp(e)-Math.exp(-e)))}function I(i,t,e){var r=st(i,t,e);return r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r}function K(i){return[[i[0]*2,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2+1,i[2]+1],[i[0]*2,i[1]*2+1,i[2]+1]]}function tt(i){return[i[0]>>1,i[1]>>1,i[2]-1]}function et(i){return K(tt(i))}function Pt(i,t){for(var e=et(i),r=0;r<e.length;r++)if(!rt(t,e[r]))return!1;return!0}function rt(i,t){for(var e=0;e<i.length;e++)if(it(i[e],t))return!0;return!1}function it(i,t){return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]}function Bt(i){for(var t="",e=i[2];e>0;e--){var r=0,s=1<<e-1;i[0]&s&&r++,i[1]&s&&(r+=2),t+=r.toString()}return t}function Wt(i){for(var t=0,e=0,r=i.length,s=r;s>0;s--){var n=1<<s-1,a=+i[r-s];a===1&&(t|=n),a===2&&(e|=n),a===3&&(t|=n,e|=n)}return[t,e,r]}function Ft(i){var t=I(i[0],i[1],32),e=I(i[2],i[3],32),r=[t[0],t[1],e[0],e[1]],s=Ct(r);if(s===0)return[0,0,0];var n=r[0]>>>32-s,a=r[1]>>>32-s;return[n,a,s]}function Ct(i){for(var t=28,e=0;e<t;e++){var r=1<<32-(e+1);if((i[0]&r)!==(i[2]&r)||(i[1]&r)!==(i[3]&r))return e}return t}function st(i,t,e){var r=Math.sin(t*xt),s=Math.pow(2,e),n=s*(i/360+.5),a=s*(.5-.25*Math.log((1+r)/(1-r))/Math.PI);return n=n%s,n<0&&(n=n+s),[n,a,e]}var B={tileToGeoJSON:bt,tileToBBOX:Y,getChildren:K,getParent:tt,getSiblings:et,hasTile:rt,hasSiblings:Pt,tilesEqual:it,tileToQuadkey:Bt,quadkeyToTile:Wt,pointToTile:I,bboxToTile:Ft,pointToTileFraction:st};class R extends V{constructor(){super();o(this,"map");o(this,"tileNo");o(this,"isDisposed",!1);o(this,"isReady",!1);o(this,"parentTile");o(this,"childrenTiles",[]);o(this,"boundingBoxWorld",new dt);o(this,"content")}init(e,r,s){this.tileNo=e,Object.freeze(this.tileNo),this.map=r,this.parentTile=s,this.visible=!1,this.renderOrder=e[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const e=this.parentTile.childrenTiles;let r=0;for(let s=0;s<e.length;s++)e[s].isReady&&r++;r===4&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:e,cameraWorldPosition:r}=this.map;if(!e.intersectsBox(this.boundingBoxWorld)){this.simplify();return}let s=this.boundingBoxWorld.distanceToPoint(r);const n=this.tileNo[2];s/=Math.pow(2,this.map.provider.maxZoom-n),s<60&&this.subdivide(),s>80&&this.simplify(),this.childrenTiles.sort((h,l)=>h.boundingBoxWorld.distanceToPoint(r)-l.boundingBoxWorld.distanceToPoint(r)).forEach(h=>h.update())}subdivide(){const{isReady:e,tileNo:r,map:s,childrenTiles:n}=this,a=r[2];if(!e||n.length>0||a>=s.maxZoom)return;B.getChildren(r).forEach(l=>{const c=new R;c.init(l,s,this),n.push(c)})}simplify(){this.childrenTiles.forEach(e=>e.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(e=>e.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}let At=class extends V{constructor(){super(...arguments);o(this,"provider");o(this,"bbox",[74.390592,6.900905,134.071423,54.318199]);o(this,"maxZoom",20);o(this,"rootForward",0);o(this,"camera");o(this,"cameraFrustum",new ft);o(this,"cameraWorldPosition",new O);o(this,"cameraProjectionMatrix",new z);o(this,"lastCameraProjectionMatrix",new z);o(this,"lastCameraWorldPosition",new O);o(this,"rootTiles",[]);o(this,"lastUpdateTime",0)}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const e=[];let r=[B.bboxToTile(this.bbox)],s=this.rootForward;for(;s>0;){const n=[...r];r=[],n.forEach(a=>{const h=B.getChildren(a);r.push(...h)}),s--}e.push(...r),e.forEach(n=>{const a=new R;a.init(n,this),this.rootTiles.push(a)})}update(){if(!this.visible||!this.camera)return;const e=Date.now();if(!(e-this.lastUpdateTime<300)){if(this.rootTiles.length===0){this.initRootTiles();return}this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),!(this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix))&&(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(r=>r.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=e)}}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};const v=class v{constructor(){o(this,"_controller",new AbortController);o(this,"listeners",new Set)}fetch(t,e={}){v.pendings.has(t)||(v.pendings.set(t,this),fetch(t,D(A({},e),{signal:this._controller.signal})).then(r=>{this.listeners.forEach(s=>s.resolve(r.clone()))}).catch(r=>{this.listeners.forEach(s=>s.reject(r))}).finally(()=>{v.pendings.delete(t)}))}abort(){this._controller.abort()}};o(v,"pendings",new Map);let x=v;class kt{constructor(t,e){o(this,"resolve");o(this,"reject");o(this,"promise");this.url=t,this.init=e,this.promise=new Promise((r,s)=>{this.resolve=r,this.reject=s})}ready(){let t=x.pendings.get(this.url);return t||(t=new x,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=x.pendings.get(this.url);t&&(t.listeners.delete(this),t.listeners.size===0&&t.abort())}}let u;async function St(i,t,e=!1,r){const n=await(await t.ready()).blob(),a=await createImageBitmap(n,e?void 0:{imageOrientation:"flipY"});if(r&&!e){u||(u=new OffscreenCanvas(256,256));const p=u.getContext("2d");if(!p)throw new Error('Offscreencanvas.getContext("2d") error!');return p.drawImage(a,0,0),p.filter=r,await createImageBitmap(u)}if(!e)return a;u||(u=new OffscreenCanvas(256,256));const h=u.getContext("2d");if(!h)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:l,height:c}=u;return h.drawImage(a,0,0),h.rect(0,0,l,c),h.strokeStyle="#00FFFF",h.font="20px Arial",h.stroke(),h.fillStyle="#FF4444",h.fillText("".concat(i[0]),10,30),h.fillStyle="#44FF44",h.fillText("".concat(i[1]),10,55),h.fillStyle="#66AAFF",h.fillText("".concat(i[2]),10,80),await createImageBitmap(u,{imageOrientation:"flipY"})}class jt{constructor(t){o(this,"worker");o(this,"terminated",!0);o(this,"map",new Map);this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((e,r)=>{this.map.set(t.id,e)})}onMessage(t){const{id:e,error:r}=t.data,s=this.map.get(e);s&&!r&&s(t.data),this.map.delete(e)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function Et(i){return new Worker("/icegl-three-vue-tres/static/MapWorker-SJHRR1eZ.js",{name:i==null?void 0:i.name})}class zt{constructor(){o(this,"maxZoom",20);o(this,"source","https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]");o(this,"showTileNo",!1);o(this,"filter","");o(this,"_useWorker",!1);o(this,"_worker");o(this,"fetching",new Map)}set useWorker(t){var e;this._useWorker=t,this._useWorker||((e=this._worker)==null||e.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const e=this.getUrl(t),r=new ut;if(this._useWorker){this._worker||(this._worker=new jt(Et));const s=this.getId(t),n=await this._worker.postMessage({id:s,tileNo:t,url:e,debug:this.showTileNo,filter:this.filter});r.image=n.bitmap}else{const s=new kt(e,{cache:"force-cache",mode:"cors"});this.fetching.set(t,s);try{r.image=await St(t,s,this.showTileNo,this.filter)}finally{this.fetching.delete(t)}}return r.needsUpdate=!0,r.anisotropy=4,r}abort(t){var e;if(this._useWorker)(e=this._worker)==null||e.postMessage({id:this.getId(t),abort:!0});else{const r=this.fetching.get(t);r&&r.abort(),this.fetching.delete(t)}}dispose(t,e){e.dispose()}getId(t){return t.join("-")}getUrl(t){const[e,r,s]=t;return this.source.indexOf("[x]")===-1?this.source.replace("{x}",e+"").replace("{y}",r+"").replace("{z}",s+""):this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",s+"")}}const J="utm",Ot="merc",H=6378137,L=Math.PI/180;function Q(i,t){const e=H*i*L,r=H*Math.log(Math.tan(Math.PI*.25+t*L*.5));return[e,r]}function f(i){return i*Math.PI/180}const It={a:6378137,b:6356752314245e-6,f:1/298.257223563},Rt="CDEFGHJKLMNPQRSTUVWXX",_t=5e5,Ut=1e7;function Xt(i,t,e){if(!(-80<=t&&t<=84))throw new RangeError("latitude ‘".concat(t,"’ outside UTM limits"));let r=e||Math.floor((i+180)/6)+1,s=f((r-1)*6-180+3);const n=Rt.charAt(Math.floor(t/8+10));r===31&&n==="V"&&i>=3?(r++,s+=f(6)):r===32&&n==="X"&&i<9?(r--,s-=f(6)):r===32&&n==="X"&&i>=9?(r++,s+=f(6)):r===34&&n==="X"&&i<21?(r--,s-=f(6)):r===34&&n==="X"&&i>=21?(r++,s+=f(6)):r===36&&n==="X"&&i<33?(r--,s-=f(6)):r===36&&n==="X"&&i>=33&&(r++,s+=f(6));const a=f(t),h=f(i)-s,{a:l,f:c}=It,p=.9996,_=Math.sqrt(c*(2-c)),m=c/(2-c),y=m*m,b=m*y,w=m*b,M=m*w,g=m*M,W=Math.cos(h),ot=Math.sin(h),T=Math.tan(a),F=Math.sinh(_*Math.atanh(_*T/Math.sqrt(1+T*T))),C=T*Math.sqrt(1+F*F)-F*Math.sqrt(1+T*T),k=Math.atan2(C,W),S=Math.asinh(ot/Math.sqrt(C*C+W*W)),U=l/(1+m)*(1+1/4*y+1/64*w+1/256*g),X=[null,1/2*m-2/3*y+5/16*b+41/180*w-127/288*M+7891/37800*g,13/48*y-3/5*b+557/1440*w+281/630*M-1983433/1935360*g,61/240*b-103/140*w+15061/26880*M+167603/181440*g,49561/161280*w-179/168*M+6601661/7257600*g,34729/80640*M-3418889/1995840*g,212378941/319334400*g];let Z=k;for(let d=1;d<=6;d++)Z+=X[d]*Math.sin(2*d*k)*Math.cosh(2*d*S);let N=S;for(let d=1;d<=6;d++)N+=X[d]*Math.cos(2*d*k)*Math.sinh(2*d*S);let j=p*U*N,P=p*U*Z;return j=j+_t,P<0&&(P=P+Ut),[j,P]}class $t{constructor(){o(this,"utmZone",50);o(this,"coordType",J);o(this,"maxZoom",20)}async getTile(t){const e=new pt,r=B.tileToBBOX(t),s=this.convertCoordinate(r[0],r[3]),n=this.convertCoordinate(r[2],r[3]),a=this.convertCoordinate(r[0],r[1]),h=this.convertCoordinate(r[2],r[1]),l=new Float32Array([s[0],s[1],0,n[0],n[1],0,a[0],a[1],0,h[0],h[1],0]);return e.setAttribute("position",new mt(l,3)),e}abort(t){}dispose(t,e){e.dispose()}convertCoordinate(t,e){switch(this.coordType){case J:return Xt(t,e,this.utmZone);case Ot:return Q(t,e);default:return Q(t,e)}}}class Zt extends gt{constructor(e){super(e);o(this,"center",new O)}}class Gt{constructor(t,e){o(this,"maxZoom",20);o(this,"showBoundingBox",!1);o(this,"wireframe",!1);o(this,"flatShading",!1);o(this,"useStandardMaterial",!1);this.geometryProvider=t,this.textureProvider=e}async getTile(t){const e=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],r=await Promise.all(e),s=r[0],n=r[1];n.colorSpace=wt;const{wireframe:a,flatShading:h}=this,l=this.useStandardMaterial?new Mt({map:n,wireframe:a,flatShading:h}):new Tt({map:n,wireframe:a}),c=new Zt;if(s.computeBoundingBox(),s.boundingBox.getCenter(c.center),s.center(),s.computeBoundingSphere(),c.position.copy(c.center),c.geometry=s,c.material=l,this.showBoundingBox){const p=new vt(s.boundingBox);c.add(p)}return c}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,e){const r=e.geometry,s=e.material;r&&this.geometryProvider.dispose(t,r),s&&s.map&&this.textureProvider.dispose(t,s.map),s==null||s.dispose()}}export{At as M,$t as P,Gt as T,J as U,zt as a,jt as b};
