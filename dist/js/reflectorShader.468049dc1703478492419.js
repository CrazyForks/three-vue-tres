import{bH as S,bI as y,bJ as F,a_ as N,aM as c,bt as R,aV as w,Z as C,aN as P,aA as T,aQ as E,b6 as d,b8 as j,aX as U,bK as O,a4 as B,w as G,o as x,c as A,V as l,J as u,D,$ as H,af as z,v as _,C as h,a7 as I,a as p,aa as L,ay as V,aD as $,a8 as k,a9 as J}from"./vendor.3b6898491703478492419.js";import{d as K}from"./dither.glsl.1a24d3091703478492419.js";import{R as Q}from"./OimoPhysicsBuffer.c2f9b41e1703478492419.js";const W="\nin vec3 position;\nin vec3 normal;\nin vec2 uv;\n\nuniform mat4 modelMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\n\nuniform mat3 uMapTransform;\nuniform mat4 uMatrix;\n\nout vec2 vUv;\nout vec4 vCoord;\nout vec3 vNormal;\nout vec3 vToEye;\n\nvoid main() {\n    vUv = (uMapTransform * vec3(uv, 1.0)).xy;\n    vCoord = uMatrix * vec4(position, 1.0);\n    vNormal = normalMatrix * normal;\n\n    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n    vToEye = cameraPosition - worldPosition.xyz;\n\n    vec4 mvPosition = viewMatrix * worldPosition;\n    gl_Position = projectionMatrix * mvPosition;\n}\n",X="\nprecision highp float;\n\nuniform sampler2D tReflect;\nuniform vec3 uColor;\nuniform float uReflectivity;\nuniform float uMirror;\nuniform float uMixStrength;\n\n#ifdef USE_MAP\n    uniform sampler2D tMap;\n#endif\n\n#ifdef USE_NORMALMAP\n    uniform sampler2D tNormalMap;\n    uniform vec2 uNormalScale;\n#endif\n\n#ifdef USE_FOG\n    uniform vec3 uFogColor;\n    uniform float uFogNear;\n    uniform float uFogFar;\n#endif\n\nin vec2 vUv;\nin vec4 vCoord;\nin vec3 vNormal;\nin vec3 vToEye;\n\nout vec4 FragColor;\n\n".concat(K,"\n\nvoid main() {\n    #ifdef USE_MAP\n        vec4 color = texture(tMap, vUv);\n    #else\n        vec4 color = vec4(uColor, 1.0);\n    #endif\n\n    #ifdef USE_NORMALMAP\n        vec4 normalColor = texture(tNormalMap, vUv * uNormalScale);\n        vec3 normal = normalize(vec3(normalColor.r * 2.0 - 1.0, normalColor.b, normalColor.g * 2.0 - 1.0));\n        vec3 coord = vCoord.xyz / vCoord.w;\n        vec2 uv = coord.xy + coord.z * normal.xz * 0.05;\n        vec4 reflectColor = texture(tReflect, uv);\n    #else\n        vec3 normal = vNormal;\n        vec4 reflectColor = textureProj(tReflect, vCoord);\n    #endif\n\n    // Fresnel term\n    vec3 toEye = normalize(vToEye);\n    float theta = max(dot(toEye, normal), 0.0);\n    float reflectance = uReflectivity + (1.0 - uReflectivity) * pow((1.0 - theta), 5.0);\n\n    reflectColor = mix(vec4(0), reflectColor, reflectance);\n\n    FragColor.rgb = color.rgb * ((1.0 - min(1.0, uMirror)) + reflectColor.rgb * uMixStrength);\n\n    #ifdef USE_FOG\n        float fogDepth = gl_FragCoord.z / gl_FragCoord.w;\n        float fogFactor = smoothstep(uFogNear, uFogFar, fogDepth);\n\n        FragColor.rgb = mix(FragColor.rgb, uFogColor, fogFactor);\n    #endif\n\n    #ifdef DITHERING\n        FragColor.rgb = dither(FragColor.rgb);\n    #endif\n\n    FragColor.a = 1.0;\n}\n");class Z extends S{constructor({color:o=new c(1052688),map:t=null,normalMap:r=null,normalScale:m=new w(1,1),reflectivity:i=0,mirror:s=0,mixStrength:a=10,fog:f=null,dithering:n=!1}={}){const e={glslVersion:y,defines:{},uniforms:{tMap:{value:null},tReflect:{value:null},uMapTransform:{value:new F},uMatrix:{value:new N},uColor:{value:o instanceof c?o:new c(o)},uReflectivity:{value:i},uMirror:{value:s},uMixStrength:{value:a}},vertexShader:W,fragmentShader:X,blending:R};t&&(t.updateMatrix(),e.defines=Object.assign(e.defines,{USE_MAP:""}),e.uniforms=Object.assign(e.uniforms,{tMap:{value:t},uMapTransform:{value:t.matrix}})),r&&(e.defines=Object.assign(e.defines,{USE_NORMALMAP:""}),e.uniforms=Object.assign(e.uniforms,{tNormalMap:{value:r},uNormalScale:{value:m}}),t||(r.updateMatrix(),e.uniforms=Object.assign(e.uniforms,{uMapTransform:{value:r.matrix}}))),f&&(e.defines=Object.assign(e.defines,{USE_FOG:""}),e.uniforms=Object.assign(e.uniforms,{uFogColor:{value:f.color},uFogNear:{value:f.near},uFogFar:{value:f.far}})),n&&(e.defines=Object.assign(e.defines,{DITHERING:""})),super(e)}}const q=["object"],Y=["object"],ee=C({__name:"reflectorShaderMesh",props:{reflectivity:{default:.2},mirror:{default:.1},mixStrength:{default:9},showGridHelper:{type:Boolean,default:!0},color:{default:"#ffffff"}},async setup(g){let o,t;const r=g,{scene:m}=P(),i=([o,t]=T(()=>E(["./plugins/floor/image/concrete_wet_floor_basecolor.jpg","./plugins/floor/image/concrete_wet_floor_normal.jpg"])),o=await o,t(),o);i[0].wrapS=d,i[0].wrapT=d,i[1].wrapS=d,i[1].wrapT=d;const s=new Q,a=new Z({reflectivity:r.reflectivity,mirror:r.mirror,mixStrength:r.mixStrength,color:new c(r.color),map:i[0],normalMap:i[1],normalScale:new w(5,5),fog:m.fog,dithering:!0});a.uniforms.tReflect=s.renderTargetUniform,a.uniforms.uMatrix=s.textureMatrixUniform;const f=new j(10,10),n=new U(f,a);n.position.y=-.01,n.rotation.x=-Math.PI/2,n.add(s),n.onBeforeRender=(v,M,b)=>{s.update(v,M,b)};const e=new O(9.5,10);return B(()=>{r.reflectivity&&(a.uniforms.uReflectivity.value=r.reflectivity),r.mirror&&(a.uniforms.uMirror.value=r.mirror),r.mixStrength&&(a.uniforms.uMixStrength.value=r.mixStrength),r.color&&(a.uniforms.uColor.value=new c(r.color))}),G(()=>r.showGridHelper,v=>{e.visible=v}),(v,M)=>(x(),A(D,null,[l("primitive",{object:u(n)},null,8,q),l("primitive",{object:u(e)},null,8,Y)],64))}}),re=l("TresPerspectiveCamera",{position:[15,15,15],fov:45,near:.1,far:1e4,"look-at":[0,0,0]},null,-1),oe=l("TresAmbientLight",{intensity:10},null,-1),te=l("TresMesh",{position:[0,2,-4]},[l("TresBoxGeometry",{args:[1,1,1]}),l("TresMeshNormalMaterial")],-1),le=C({__name:"reflectorShader",setup(g){const o=H({reflectivity:.49,mirror:.25,mixStrength:26,showGridHelper:!0}),t=new z({title:"镜面参数",expanded:!0});return t.addBinding(o,"reflectivity",{label:"反射率",min:.01,max:1,step:.01}),t.addBinding(o,"mirror",{label:"镜面化",min:0,max:1,step:.01}),t.addBinding(o,"mixStrength",{label:"混合",min:0,max:100,step:1}),t.addBinding(o,"showGridHelper",{label:"显示网格"}),(r,m)=>(x(),_(u(I),{clearColor:"#201919","window-size":""},{default:h(()=>[re,p(u(L),{enableDamping:""}),oe,p(u(V),{args:[1,1,1],color:"orange",position:[3,1,0]}),te,(x(),_($,null,{default:h(()=>[p(ee,k(J(o)),null,16)]),_:1}))]),_:1}))}});export{le as default};
