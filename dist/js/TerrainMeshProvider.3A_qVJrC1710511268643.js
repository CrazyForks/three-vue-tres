var at=Object.defineProperty,ht=Object.defineProperties;var ct=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var lt=Object.prototype.hasOwnProperty,dt=Object.prototype.propertyIsEnumerable;var U=(i,t,e)=>t in i?at(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,G=(i,t)=>{for(var e in t||(t={}))lt.call(t,e)&&U(i,e,t[e]);if(q)for(var e of q(t))dt.call(t,e)&&U(i,e,t[e]);return i},z=(i,t)=>ht(i,ct(t));var n=(i,t,e)=>(U(i,typeof t!="symbol"?t+"":t,e),e);import{cj as Q,be as ut,at as Y,cA as ft,b0 as R,bd as g,b_ as pt,br as mt,as as gt,a2 as vt,au as Mt,cB as xt,b9 as wt,cC as Tt}from"./vendor.St8dZPm41710511268643.js";var yt=Math.PI/180,bt=180/Math.PI;function K(i){var t=N(i[0]+1,i[2]),e=N(i[0],i[2]),r=J(i[1]+1,i[2]),o=J(i[1],i[2]);return[e,r,t,o]}function Pt(i){var t=K(i),e={type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]};return e}function N(i,t){return i/Math.pow(2,t)*360-180}function J(i,t){var e=Math.PI-2*Math.PI*i/Math.pow(2,t);return bt*Math.atan(.5*(Math.exp(e)-Math.exp(-e)))}function E(i,t,e){var r=st(i,t,e);return r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r}function tt(i){return[[i[0]*2,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2+1,i[2]+1],[i[0]*2,i[1]*2+1,i[2]+1]]}function et(i){return[i[0]>>1,i[1]>>1,i[2]-1]}function rt(i){return tt(et(i))}function Ct(i,t){for(var e=rt(i),r=0;r<e.length;r++)if(!it(t,e[r]))return!1;return!0}function it(i,t){for(var e=0;e<i.length;e++)if(ot(i[e],t))return!0;return!1}function ot(i,t){return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]}function Bt(i){for(var t="",e=i[2];e>0;e--){var r=0,o=1<<e-1;i[0]&o&&r++,i[1]&o&&(r+=2),t+=r.toString()}return t}function _t(i){for(var t=0,e=0,r=i.length,o=r;o>0;o--){var s=1<<o-1,a=+i[r-o];a===1&&(t|=s),a===2&&(e|=s),a===3&&(t|=s,e|=s)}return[t,e,r]}function Wt(i){var t=E(i[0],i[1],32),e=E(i[2],i[3],32),r=[t[0],t[1],e[0],e[1]],o=Ft(r);if(o===0)return[0,0,0];var s=r[0]>>>32-o,a=r[1]>>>32-o;return[s,a,o]}function Ft(i){for(var t=28,e=0;e<t;e++){var r=1<<32-(e+1);if((i[0]&r)!==(i[2]&r)||(i[1]&r)!==(i[3]&r))return e}return t}function st(i,t,e){var r=Math.sin(t*yt),o=Math.pow(2,e),s=o*(i/360+.5),a=o*(.5-.25*Math.log((1+r)/(1-r))/Math.PI);return s=s%o,s<0&&(s=s+o),[s,a,e]}var _={tileToGeoJSON:Pt,tileToBBOX:K,getChildren:tt,getParent:et,getSiblings:rt,hasTile:it,hasSiblings:Ct,tilesEqual:ot,tileToQuadkey:Bt,quadkeyToTile:_t,pointToTile:E,bboxToTile:Wt,pointToTileFraction:st};class I extends Q{constructor(){super();n(this,"map");n(this,"tileNo");n(this,"isDisposed",!1);n(this,"isReady",!1);n(this,"parentTile");n(this,"childrenTiles",[]);n(this,"boundingBoxWorld",new ut);n(this,"content")}init(e,r,o){this.tileNo=e,Object.freeze(this.tileNo),this.map=r,this.parentTile=o,this.visible=!1,this.renderOrder=e[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const e=this.parentTile.childrenTiles;let r=0;for(let o=0;o<e.length;o++)e[o].isReady&&r++;r===4&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:e,cameraWorldPosition:r}=this.map;if(!e.intersectsBox(this.boundingBoxWorld)){this.simplify();return}this.content instanceof Y&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let o=this.boundingBoxWorld.distanceToPoint(r);const s=this.tileNo[2];o/=Math.pow(2,this.map.provider.maxZoom-s),o<60&&this.subdivide(),o>80&&this.simplify(),this.childrenTiles.sort((c,h)=>c.boundingBoxWorld.distanceToPoint(r)-h.boundingBoxWorld.distanceToPoint(r)).forEach(c=>c.update())}subdivide(){const{isReady:e,tileNo:r,map:o,childrenTiles:s}=this,a=r[2];if(!e||s.length>0||a>=o.maxZoom)return;_.getChildren(r).forEach(h=>{const l=new I;l.init(h,o,this),s.push(l)})}simplify(){this.childrenTiles.forEach(e=>e.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(e=>e.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}let Gt=class extends Q{constructor(){super(...arguments);n(this,"provider");n(this,"bbox",[74.390592,6.900905,134.071423,54.318199]);n(this,"maxZoom",20);n(this,"rootForward",0);n(this,"camera");n(this,"cameraFrustum",new ft);n(this,"cameraWorldPosition",new R);n(this,"cameraProjectionMatrix",new g);n(this,"lastCameraProjectionMatrix",new g);n(this,"lastCameraWorldPosition",new R);n(this,"rootTiles",[]);n(this,"lastUpdateTime",0)}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const e=[];let r=[_.bboxToTile(this.bbox)],o=this.rootForward;for(;o>0;){const s=[...r];r=[],s.forEach(a=>{const c=_.getChildren(a);r.push(...c)}),o--}e.push(...r),e.forEach(s=>{const a=new I;a.init(s,this),this.rootTiles.push(a)})}update(){if(!this.visible||!this.camera)return;const e=Date.now();if(!(e-this.lastUpdateTime<300)){if(this.rootTiles.length===0){this.initRootTiles();return}this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),!(this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix))&&(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(r=>r.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=e)}}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};const T=class T{constructor(){n(this,"_controller",new AbortController);n(this,"listeners",new Set)}fetch(t,e={}){T.pendings.has(t)||(T.pendings.set(t,this),fetch(t,z(G({},e),{signal:this._controller.signal})).then(r=>{this.listeners.forEach(o=>o.resolve(r.clone()))}).catch(r=>{this.listeners.forEach(o=>o.reject(r))}).finally(()=>{T.pendings.delete(t)}))}abort(){this._controller.abort()}};n(T,"pendings",new Map);let b=T;class St{constructor(t,e){n(this,"resolve");n(this,"reject");n(this,"promise");this.url=t,this.init=e,this.promise=new Promise((r,o)=>{this.resolve=r,this.reject=o})}ready(){let t=b.pendings.get(this.url);return t||(t=new b,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=b.pendings.get(this.url);t&&(t.listeners.delete(this),t.listeners.size===0&&t.abort())}}let y;async function kt(i,t,e=!1){const o=await(await t.ready()).blob(),s=await createImageBitmap(o,e?void 0:{imageOrientation:"flipY"});if(!e)return s;y||(y=new OffscreenCanvas(256,256));const a=y.getContext("2d");if(!a)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:c,height:h}=y;return a.drawImage(s,0,0),a.rect(0,0,c,h),a.strokeStyle="#00FFFF",a.font="20px Arial",a.stroke(),a.fillStyle="#FF4444",a.fillText("".concat(i[0]),10,30),a.fillStyle="#44FF44",a.fillText("".concat(i[1]),10,55),a.fillStyle="#66AAFF",a.fillText("".concat(i[2]),10,80),await createImageBitmap(y,{imageOrientation:"flipY"})}class jt{constructor(t){n(this,"worker");n(this,"terminated",!0);n(this,"map",new Map);this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((e,r)=>{this.map.set(t.id,e)})}onMessage(t){const{id:e,error:r}=t.data,o=this.map.get(e);o&&!r&&o(t.data),this.map.delete(e)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function Ot(i){return new Worker(""+new URL("../static/MapWorker-P8uJfnMJ.js",import.meta.url).href,{name:i==null?void 0:i.name})}class Nt{constructor(){n(this,"maxZoom",20);n(this,"source","https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]");n(this,"showTileNo",!1);n(this,"_useWorker",!1);n(this,"_worker");n(this,"fetching",new Map)}set useWorker(t){var e;this._useWorker=t,this._useWorker||((e=this._worker)==null||e.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const e=this.getUrl(t),r=new pt;if(this._useWorker){this._worker||(this._worker=new jt(Ot));const o=this.getId(t),s=await this._worker.postMessage({id:o,tileNo:t,url:e,debug:this.showTileNo});r.image=s.bitmap}else{const o=new St(e,{cache:"force-cache",mode:"cors"});this.fetching.set(t,o);try{r.image=await kt(t,o,this.showTileNo)}finally{this.fetching.delete(t)}}return r.needsUpdate=!0,r.anisotropy=4,r}abort(t){var e;if(this._useWorker)(e=this._worker)==null||e.postMessage({id:this.getId(t),abort:!0});else{const r=this.fetching.get(t);r&&r.abort(),this.fetching.delete(t)}}dispose(t,e){e.dispose()}getId(t){return t.join("-")}getUrl(t){const[e,r,o]=t;return this.source.indexOf("[x]")===-1?this.source.replace("{x}",e+"").replace("{y}",r+"").replace("{z}",o+""):this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",o+"")}}const L="utm",Ut="merc",$=6378137,V=Math.PI/180;function H(i,t){const e=$*i*V,r=$*Math.log(Math.tan(Math.PI*.25+t*V*.5));return[e,r]}function f(i){return i*Math.PI/180}const Rt={a:6378137,b:6356752314245e-6,f:1/298.257223563},Et="CDEFGHJKLMNPQRSTUVWXX",It=5e5,Xt=1e7;function Dt(i,t,e){if(!(-80<=t&&t<=84))throw new RangeError("latitude ‘".concat(t,"’ outside UTM limits"));let r=e||Math.floor((i+180)/6)+1,o=f((r-1)*6-180+3);const s=Et.charAt(Math.floor(t/8+10));r===31&&s==="V"&&i>=3?(r++,o+=f(6)):r===32&&s==="X"&&i<9?(r--,o-=f(6)):r===32&&s==="X"&&i>=9?(r++,o+=f(6)):r===34&&s==="X"&&i<21?(r--,o-=f(6)):r===34&&s==="X"&&i>=21?(r++,o+=f(6)):r===36&&s==="X"&&i<33?(r--,o-=f(6)):r===36&&s==="X"&&i>=33&&(r++,o+=f(6));const a=f(t),c=f(i)-o,{a:h,f:l}=Rt,d=.9996,p=Math.sqrt(l*(2-l)),m=l/(2-l),P=m*m,C=m*P,M=m*C,x=m*M,v=m*x,W=Math.cos(c),nt=Math.sin(c),w=Math.tan(a),F=Math.sinh(p*Math.atanh(p*w/Math.sqrt(1+w*w))),S=w*Math.sqrt(1+F*F)-F*Math.sqrt(1+w*w),k=Math.atan2(S,W),j=Math.asinh(nt/Math.sqrt(S*S+W*W)),X=h/(1+m)*(1+1/4*P+1/64*M+1/256*v),D=[null,1/2*m-2/3*P+5/16*C+41/180*M-127/288*x+7891/37800*v,13/48*P-3/5*C+557/1440*M+281/630*x-1983433/1935360*v,61/240*C-103/140*M+15061/26880*x+167603/181440*v,49561/161280*M-179/168*x+6601661/7257600*v,34729/80640*x-3418889/1995840*v,212378941/319334400*v];let Z=k;for(let u=1;u<=6;u++)Z+=D[u]*Math.sin(2*u*k)*Math.cosh(2*u*j);let A=j;for(let u=1;u<=6;u++)A+=D[u]*Math.cos(2*u*k)*Math.sinh(2*u*j);let O=d*X*A,B=d*X*Z;return O=O+It,B<0&&(B=B+Xt),[O,B]}class Jt{constructor(){n(this,"utmZone",50);n(this,"coordType",L);n(this,"maxZoom",20)}async getTile(t){const e=new mt,r=_.tileToBBOX(t),o=this.convertCoordinate(r[0],r[3]),s=this.convertCoordinate(r[2],r[3]),a=this.convertCoordinate(r[0],r[1]),c=this.convertCoordinate(r[2],r[1]),h=new Float32Array([o[0],o[1],0,s[0],s[1],0,a[0],a[1],0,c[0],c[1],0]);return e.setAttribute("position",new gt(h,3)),e}abort(t){}dispose(t,e){e.dispose()}convertCoordinate(t,e){switch(this.coordType){case L:return Dt(t,e,this.utmZone);case Ut:return H(t,e);default:return H(t,e)}}}class Zt extends Y{constructor(e){super(e);n(this,"center",new R)}}class Lt{constructor(t,e){n(this,"maxZoom",20);n(this,"showBoundingBox",!1);n(this,"wireframe",!1);n(this,"flatShading",!1);n(this,"useStandardMaterial",!1);n(this,"filter",null);this.geometryProvider=t,this.textureProvider=e}getTranMatrix(){var e,r,o,s,a;let t=new g;if((e=this.filter)!=null&&e.opposite){let c=new g;c.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),t.multiply(c)}if((r=this.filter)!=null&&r.monochrome){let c=new g;const h=this.filter.monochrome.r,l=this.filter.monochrome.g,d=this.filter.monochrome.b;c.set(h,l,d,0,h,l,d,0,h,l,d,0,0,0,0,1),t.multiply(c)}if((o=this.filter)!=null&&o.genBright){let c=new g;const h=this.filter.genBright;c.set(h,0,0,0,0,h,0,0,0,0,h,0,0,0,0,1),t.multiply(c)}if((s=this.filter)!=null&&s.genContrast){let c=new g;const h=this.filter.genContrast,l=.5*(1-h);c.set(h,0,0,0,0,h,0,0,0,0,h,0,l,l,l,1),t.multiply(c)}if((a=this.filter)!=null&&a.genSaturate){let c=new g;const h=this.filter.genSaturate,l=.3*(1-h),d=.6*(1-h),p=.1*(1-h);c.set(l+h,l,l,0,d,d+h,d,0,p,p,p+h,0,0,0,0,1),t.multiply(c)}return t}async getTile(t){const e=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],r=await Promise.all(e),o=r[0],s=r[1];s.colorSpace=vt;const{wireframe:a,flatShading:c}=this;let h=null;const l=t[0]+t[1]+t[2];this.filter?h=new Mt({wireframe:a,depthTest:!0,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:1,uniforms:{e_Texture:{value:s},t_Matrix:{value:this.getTranMatrix()}},vertexShader:"\n                varying vec2 v_Uv;    //顶点纹理坐标\n                void main () {\n                    v_Uv = uv;\n                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n                ",fragmentShader:"\n                uniform sampler2D e_Texture;     //纹理图像\n                varying vec2 v_Uv;               //片元纹理坐标\n                uniform mat4 t_Matrix;     //接收变换矩阵\n                void main () {\n                    // gl_FragColor = texture2D( e_Texture, v_Uv );\n\n                    // vec4 textureColor = texture2D( e_Texture, v_Uv );\n                    // //计算加权平均值\n                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;\n                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);\n\n                    vec4 textureColor = texture2D( e_Texture, v_Uv );\n                    //变换矩阵乘以 vec4(R,G,B,1)    --->vec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示\n                    //vec4(R,G,B,1)第四个分量不是透明度\n                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; \n                    //设置透明度\n                    transColor.a = 1.0;\n                    gl_FragColor = transColor;\n                }"}):h=this.useStandardMaterial?new xt({map:s,wireframe:a,flatShading:c}):new wt({map:s,wireframe:a});const d=new Zt;if(d.renderOrder=l,o.computeBoundingBox(),o.boundingBox.getCenter(d.center),o.center(),o.computeBoundingSphere(),d.position.copy(d.center),d.geometry=o,d.material=h,this.showBoundingBox){const p=new Tt(o.boundingBox);d.add(p)}return d}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,e){const r=e.geometry,o=e.material;r&&this.geometryProvider.dispose(t,r),o&&o.map&&this.textureProvider.dispose(t,o.map),o==null||o.dispose()}}export{Gt as M,Jt as P,Lt as T,L as U,Nt as a,jt as b,Ut as c,H as d,Dt as l};
