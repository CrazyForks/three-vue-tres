var ve=Object.defineProperty,xe=Object.defineProperties;var Me=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var Te=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var z=(s,e,t)=>e in s?ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,q=(s,e)=>{for(var t in e||(e={}))Te.call(e,t)&&z(s,t,e[t]);if($)for(var t of $(e))be.call(e,t)&&z(s,t,e[t]);return s},Q=(s,e)=>xe(s,Me(e));var o=(s,e,t)=>(z(s,typeof e!="symbol"?e+"":e,t),t);import{cc as se,be as ye,cy as Pe,aQ as Z,bd as G,bP as ke,bo as _e,b6 as W,b5 as V,at as We,cz as Be,b3 as Ce,cA as Fe,$ as ie,a0 as oe,k as je,ak as Ie,a5 as Se,a4 as Ee,o as O,c as ze,a as ae,a7 as ne,K as R,ab as Ze,W as ce,E as Oe,v as Y,D as H,a8 as Re,ag as Ue}from"./vendor.y4J6Y3vB1708945120723.js";var Xe=Math.PI/180,Ae=180/Math.PI;function he(s){var e=J(s[0]+1,s[2]),t=J(s[0],s[2]),r=K(s[1]+1,s[2]),i=K(s[1],s[2]);return[t,r,e,i]}function De(s){var e=he(s),t={type:"Polygon",coordinates:[[[e[0],e[3]],[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]]};return t}function J(s,e){return s/Math.pow(2,e)*360-180}function K(s,e){var t=Math.PI-2*Math.PI*s/Math.pow(2,e);return Ae*Math.atan(.5*(Math.exp(t)-Math.exp(-t)))}function U(s,e,t){var r=me(s,e,t);return r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r}function le(s){return[[s[0]*2,s[1]*2,s[2]+1],[s[0]*2+1,s[1]*2,s[2]+1],[s[0]*2+1,s[1]*2+1,s[2]+1],[s[0]*2,s[1]*2+1,s[2]+1]]}function ue(s){return[s[0]>>1,s[1]>>1,s[2]-1]}function de(s){return le(ue(s))}function Ne(s,e){for(var t=de(s),r=0;r<t.length;r++)if(!fe(e,t[r]))return!1;return!0}function fe(s,e){for(var t=0;t<s.length;t++)if(pe(s[t],e))return!0;return!1}function pe(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]}function Le(s){for(var e="",t=s[2];t>0;t--){var r=0,i=1<<t-1;s[0]&i&&r++,s[1]&i&&(r+=2),e+=r.toString()}return e}function $e(s){for(var e=0,t=0,r=s.length,i=r;i>0;i--){var a=1<<i-1,n=+s[r-i];n===1&&(e|=a),n===2&&(t|=a),n===3&&(e|=a,t|=a)}return[e,t,r]}function qe(s){var e=U(s[0],s[1],32),t=U(s[2],s[3],32),r=[e[0],e[1],t[0],t[1]],i=Qe(r);if(i===0)return[0,0,0];var a=r[0]>>>32-i,n=r[1]>>>32-i;return[a,n,i]}function Qe(s){for(var e=28,t=0;t<e;t++){var r=1<<32-(t+1);if((s[0]&r)!==(s[2]&r)||(s[1]&r)!==(s[3]&r))return t}return e}function me(s,e,t){var r=Math.sin(e*Xe),i=Math.pow(2,t),a=i*(s/360+.5),n=i*(.5-.25*Math.log((1+r)/(1-r))/Math.PI);return a=a%i,a<0&&(a=a+i),[a,n,t]}var B={tileToGeoJSON:De,tileToBBOX:he,getChildren:le,getParent:ue,getSiblings:de,hasTile:fe,hasSiblings:Ne,tilesEqual:pe,tileToQuadkey:Le,quadkeyToTile:$e,pointToTile:U,bboxToTile:qe,pointToTileFraction:me};class X extends se{constructor(){super();o(this,"map");o(this,"tileNo");o(this,"isDisposed",!1);o(this,"isReady",!1);o(this,"parentTile");o(this,"childrenTiles",[]);o(this,"boundingBoxWorld",new ye);o(this,"content")}init(t,r,i){this.tileNo=t,Object.freeze(this.tileNo),this.map=r,this.parentTile=i,this.visible=!1,this.renderOrder=t[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const t=this.parentTile.childrenTiles;let r=0;for(let i=0;i<t.length;i++)t[i].isReady&&r++;r===4&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:t,cameraWorldPosition:r}=this.map;if(!t.intersectsBox(this.boundingBoxWorld)){this.simplify();return}let i=this.boundingBoxWorld.distanceToPoint(r);const a=this.tileNo[2];i/=Math.pow(2,this.map.provider.maxZoom-a),i<60&&this.subdivide(),i>80&&this.simplify(),this.childrenTiles.sort((h,l)=>h.boundingBoxWorld.distanceToPoint(r)-l.boundingBoxWorld.distanceToPoint(r)).forEach(h=>h.update())}subdivide(){const{isReady:t,tileNo:r,map:i,childrenTiles:a}=this,n=r[2];if(!t||a.length>0||n>=i.maxZoom)return;B.getChildren(r).forEach(l=>{const c=new X;c.init(l,i,this),a.push(c)})}simplify(){this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}let Ge=class extends se{constructor(){super(...arguments);o(this,"provider");o(this,"bbox",[74.390592,6.900905,134.071423,54.318199]);o(this,"maxZoom",20);o(this,"rootForward",0);o(this,"camera");o(this,"cameraFrustum",new Pe);o(this,"cameraWorldPosition",new Z);o(this,"cameraProjectionMatrix",new G);o(this,"lastCameraProjectionMatrix",new G);o(this,"lastCameraWorldPosition",new Z);o(this,"rootTiles",[]);o(this,"lastUpdateTime",0)}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const t=[];let r=[B.bboxToTile(this.bbox)],i=this.rootForward;for(;i>0;){const a=[...r];r=[],a.forEach(n=>{const h=B.getChildren(n);r.push(...h)}),i--}t.push(...r),t.forEach(a=>{const n=new X;n.init(a,this),this.rootTiles.push(n)})}update(){if(!this.visible||!this.camera)return;const t=Date.now();if(!(t-this.lastUpdateTime<300)){if(this.rootTiles.length===0){this.initRootTiles();return}this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),!(this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix))&&(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(r=>r.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=t)}}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};const b=class b{constructor(){o(this,"_controller",new AbortController);o(this,"listeners",new Set)}fetch(e,t={}){b.pendings.has(e)||(b.pendings.set(e,this),fetch(e,Q(q({},t),{signal:this._controller.signal})).then(r=>{this.listeners.forEach(i=>i.resolve(r.clone()))}).catch(r=>{this.listeners.forEach(i=>i.reject(r))}).finally(()=>{b.pendings.delete(e)}))}abort(){this._controller.abort()}};o(b,"pendings",new Map);let P=b;class Ve{constructor(e,t){o(this,"resolve");o(this,"reject");o(this,"promise");this.url=e,this.init=t,this.promise=new Promise((r,i)=>{this.resolve=r,this.reject=i})}ready(){let e=P.pendings.get(this.url);return e||(e=new P,e.fetch(this.url,this.init)),e.listeners.add(this),this.promise}abort(){this.reject("User abort.");const e=P.pendings.get(this.url);e&&(e.listeners.delete(this),e.listeners.size===0&&e.abort())}}let y;async function Ye(s,e,t=!1){const i=await(await e.ready()).blob(),a=await createImageBitmap(i,t?void 0:{imageOrientation:"flipY"});if(!t)return a;y||(y=new OffscreenCanvas(256,256));const n=y.getContext("2d");if(!n)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:h,height:l}=y;return n.drawImage(a,0,0),n.rect(0,0,h,l),n.strokeStyle="#00FFFF",n.font="20px Arial",n.stroke(),n.fillStyle="#FF4444",n.fillText("".concat(s[0]),10,30),n.fillStyle="#44FF44",n.fillText("".concat(s[1]),10,55),n.fillStyle="#66AAFF",n.fillText("".concat(s[2]),10,80),await createImageBitmap(y,{imageOrientation:"flipY"})}class ge{constructor(e){o(this,"worker");o(this,"terminated",!0);o(this,"map",new Map);this.worker=new e,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(e){if(!this.terminated)return this.worker.postMessage(e),new Promise((t,r)=>{this.map.set(e.id,t)})}onMessage(e){const{id:t,error:r}=e.data,i=this.map.get(t);i&&!r&&i(e.data),this.map.delete(t)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function He(s){return new Worker("/icegl-three-vue-tres/static/MapWorker-YleTgTmv.js",{name:s==null?void 0:s.name})}class Je{constructor(){o(this,"maxZoom",20);o(this,"source","https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]");o(this,"showTileNo",!1);o(this,"_useWorker",!1);o(this,"_worker");o(this,"fetching",new Map)}set useWorker(e){var t;this._useWorker=e,this._useWorker||((t=this._worker)==null||t.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(e){const t=this.getUrl(e),r=new ke;if(this._useWorker){this._worker||(this._worker=new ge(He));const i=this.getId(e),a=await this._worker.postMessage({id:i,tileNo:e,url:t,debug:this.showTileNo});r.image=a.bitmap}else{const i=new Ve(t,{cache:"force-cache"});this.fetching.set(e,i);try{r.image=await Ye(e,i,this.showTileNo)}finally{this.fetching.delete(e)}}return r.needsUpdate=!0,r.anisotropy=4,r}abort(e){var t;if(this._useWorker)(t=this._worker)==null||t.postMessage({id:this.getId(e),abort:!0});else{const r=this.fetching.get(e);r&&r.abort(),this.fetching.delete(e)}}dispose(e,t){t.dispose()}getId(e){return e.join("-")}getUrl(e){const[t,r,i]=e;return this.source.indexOf("[x]")===-1?this.source.replace("{x}",t+"").replace("{y}",r+"").replace("{z}",i+""):this.source.replace("[x]",t+"").replace("[y]",r+"").replace("[z]",i+"")}}const k="utm",Ke="merc",ee=6378137,te=Math.PI/180;function re(s,e){const t=ee*s*te,r=ee*Math.log(Math.tan(Math.PI*.25+e*te*.5));return[t,r]}function f(s){return s*Math.PI/180}const et={a:6378137,b:6356752314245e-6,f:1/298.257223563},tt="CDEFGHJKLMNPQRSTUVWXX",rt=5e5,st=1e7;function it(s,e,t){if(!(-80<=e&&e<=84))throw new RangeError("latitude ‘".concat(e,"’ outside UTM limits"));let r=t||Math.floor((s+180)/6)+1,i=f((r-1)*6-180+3);const a=tt.charAt(Math.floor(e/8+10));r===31&&a==="V"&&s>=3?(r++,i+=f(6)):r===32&&a==="X"&&s<9?(r--,i-=f(6)):r===32&&a==="X"&&s>=9?(r++,i+=f(6)):r===34&&a==="X"&&s<21?(r--,i-=f(6)):r===34&&a==="X"&&s>=21?(r++,i+=f(6)):r===36&&a==="X"&&s<33?(r--,i-=f(6)):r===36&&a==="X"&&s>=33&&(r++,i+=f(6));const n=f(e),h=f(s)-i,{a:l,f:c}=et,p=.9996,m=Math.sqrt(c*(2-c)),u=c/(2-c),w=u*u,M=u*w,g=u*M,v=u*g,x=u*v,C=Math.cos(h),we=Math.sin(h),T=Math.tan(n),F=Math.sinh(m*Math.atanh(m*T/Math.sqrt(1+T*T))),j=T*Math.sqrt(1+F*F)-F*Math.sqrt(1+T*T),I=Math.atan2(j,C),S=Math.asinh(we/Math.sqrt(j*j+C*C)),A=l/(1+u)*(1+1/4*w+1/64*g+1/256*x),D=[null,1/2*u-2/3*w+5/16*M+41/180*g-127/288*v+7891/37800*x,13/48*w-3/5*M+557/1440*g+281/630*v-1983433/1935360*x,61/240*M-103/140*g+15061/26880*v+167603/181440*x,49561/161280*g-179/168*v+6601661/7257600*x,34729/80640*v-3418889/1995840*x,212378941/319334400*x];let N=I;for(let d=1;d<=6;d++)N+=D[d]*Math.sin(2*d*I)*Math.cosh(2*d*S);let L=S;for(let d=1;d<=6;d++)L+=D[d]*Math.cos(2*d*I)*Math.sinh(2*d*S);let E=p*A*L,_=p*A*N;return E=E+rt,_<0&&(_=_+st),[E,_]}class ot{constructor(){o(this,"utmZone",50);o(this,"coordType",k);o(this,"maxZoom",20)}async getTile(e){const t=new _e,r=B.tileToBBOX(e),i=this.convertCoordinate(r[0],r[3]),a=this.convertCoordinate(r[2],r[3]),n=this.convertCoordinate(r[0],r[1]),h=this.convertCoordinate(r[2],r[1]),l=new Float32Array([i[0],i[1],0,a[0],a[1],0,n[0],n[1],0,h[0],h[1],0]);return t.setAttribute("position",new W(l,3)),t}abort(e){}dispose(e,t){t.dispose()}convertCoordinate(e,t){switch(this.coordType){case k:return it(e,t,this.utmZone);case Ke:return re(e,t);default:return re(e,t)}}}function at(s){return new Worker("/icegl-three-vue-tres/static/MartiniWorker-8mf_OiU3.js",{name:s==null?void 0:s.name})}class nt{constructor(){o(this,"maxZoom",12);o(this,"coordType",k);o(this,"utmZone",50);o(this,"_worker");o(this,"_useWorker",!0);o(this,"source","https://api.maptiler.com/tiles/terrain-rgb-v2/[z]/[x]/[y].webp?key=L55MtSxL94Yb4hQeWewp")}set useWorker(e){var t;this._useWorker=e,this._useWorker||((t=this._worker)==null||t.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(e){return this._useWorker?this.getInWorkerThread(e):this.getInMainThread()}async getInMainThread(){return new V}async getInWorkerThread(e){this._worker||(this._worker=new ge(at));const t={tileNo:e,id:this.getId(e),url:this.getUrl(e),maxZ:this.maxZoom,coordType:this.coordType,utmZone:this.utmZone},r=await this._worker.postMessage(t),i=new V;return i.setAttribute("position",new W(r.positions,3)),i.setAttribute("uv",new W(r.uv,2)),i.setIndex(new W(r.triangles,1)),i}async abort(e){var t;this._useWorker&&((t=this._worker)==null||t.postMessage({id:this.getId(e),abort:!0}))}async dispose(e,t){var r;t.dispose(),this._useWorker&&((r=this._worker)==null||r.postMessage({id:this.getId(e),dispose:!0}))}getId(e){return e.join("-")}getUrl(e){const[t,r,i]=e;return this.source.replace("[x]",t+"").replace("[y]",r+"").replace("[z]",i+"")}}class ct extends We{constructor(t){super(t);o(this,"center",new Z)}}class ht{constructor(e,t){o(this,"maxZoom",20);o(this,"showBoundingBox",!1);o(this,"wireframe",!1);o(this,"flatShading",!1);o(this,"useStandardMaterial",!1);this.geometryProvider=e,this.textureProvider=t}async getTile(e){const t=[this.geometryProvider.getTile(e),this.textureProvider.getTile(e)],r=await Promise.all(t),i=r[0],a=r[1],{wireframe:n,flatShading:h}=this,l=this.useStandardMaterial?new Be({map:a,wireframe:n,flatShading:h}):new Ce({map:a,wireframe:n}),c=new ct;if(i.computeBoundingBox(),i.boundingBox.getCenter(c.center),i.center(),i.computeBoundingSphere(),c.position.copy(c.center),c.geometry=i,c.material=l,this.showBoundingBox){const p=new Fe(i.boundingBox);c.add(p)}return c}abort(e){this.geometryProvider.abort(e),this.textureProvider.abort(e)}dispose(e,t){const r=t.geometry,i=t.material;r&&this.geometryProvider.dispose(e,r),i&&i.map&&this.textureProvider.dispose(e,i.map),i==null||i.dispose()}}const lt=["object"],ut=ie({__name:"tileMapMesh",props:{bbox:{default:[104.955976,20.149765,120.998419,30.528687]},maxZoom:{default:20}},setup(s){const e=s,t=oe({enableDamping:!0,dampingFactor:.05}),r=je(),{camera:i,renderer:a,scene:n}=Ie(),h=new ot;h.coordType=k;const l=new nt;l.source="https://api.maptiler.com/tiles/terrain-rgb-v2/[z]/[x]/[y].webp?key=L55MtSxL94Yb4hQeWewp",l.coordType=k;const c=new Je;c.source="https://webrd04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}",c.showTileNo=!1,c.useWorker=!0;const p=new ht(l,c);p.showBoundingBox=!1,p.wireframe=!1,p.flatShading=!1;const m=new Ge;m.provider=p,m.bbox=e.bbox,m.maxZoom=e.maxZoom;let u=!1,w=!1;Se(()=>{i.value&&!u&&(u=!0,m.camera=i.value),r.value&&!w&&(w=!0,r.value.value.target.x=i.value.position.x,r.value.value.target.y=i.value.position.y,r.value.value.target.z=0)});const{onLoop:M}=Ee();return M(()=>{if(a.value){const g=Math.abs(i.value.position.z)*50;i.value.far=g+5e3,i.value.updateProjectionMatrix(),r.value&&(r.value.value.target.z=0),m.update(),a.value.render(n.value,i.value)}}),(g,v)=>(O(),ze(Oe,null,[ae(R(Ze),ne(t,{ref_key:"orbitControlRef",ref:r}),null,16),ce("primitive",{object:R(m)},null,8,lt)],64))}}),dt=["look-at"],gt=ie({__name:"tileMap",setup(s){const e=oe({clearColor:"#201919",logarithmicDepthBuffer:!0,antialias:!0,disableRender:!0}),t=[958792.6688235556,2771848203330192e-9,1241.0896440063382];return(r,i)=>(O(),Y(R(Re),ne(e,{"window-size":""}),{default:H(()=>[ce("TresPerspectiveCamera",{position:t,fov:60,near:1,far:1e8,"look-at":[t[0],t[1],0],up:[0,0,1]},null,8,dt),(O(),Y(Ue,null,{default:H(()=>[ae(ut,{bbox:[104.955976,20.149765,120.998419,30.528687]})]),_:1}))]),_:1},16))}});export{gt as default};
