var v=Object.defineProperty,C=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var u=(r,s,t)=>s in r?v(r,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[s]=t,y=(r,s)=>{for(var t in s||(s={}))O.call(s,t)&&u(r,t,s[t]);if(b)for(var t of b(s))I.call(s,t)&&u(r,t,s[t]);return r},F=(r,s)=>C(r,M(s));var c=(r,s,t)=>(u(r,typeof s!="symbol"?s+"":s,t),t);(function(){"use strict";const l=class l{constructor(){c(this,"_controller",new AbortController);c(this,"listeners",new Set)}fetch(e,a={}){l.pendings.has(e)||(l.pendings.set(e,this),fetch(e,F(y({},a),{signal:this._controller.signal})).then(n=>{this.listeners.forEach(o=>o.resolve(n.clone()))}).catch(n=>{this.listeners.forEach(o=>o.reject(n))}).finally(()=>{l.pendings.delete(e)}))}abort(){this._controller.abort()}};c(l,"pendings",new Map);let r=l;class s{constructor(e,a){c(this,"resolve");c(this,"reject");c(this,"promise");this.url=e,this.init=a,this.promise=new Promise((n,o)=>{this.resolve=n,this.reject=o})}ready(){let e=r.pendings.get(this.url);return e||(e=new r,e.fetch(this.url,this.init)),e.listeners.add(this),this.promise}abort(){this.reject("User abort.");const e=r.pendings.get(this.url);e&&(e.listeners.delete(this),e.listeners.size===0&&e.abort())}}let t;async function x(f,e,a=!1,n){const w=await(await e.ready()).blob(),h=await createImageBitmap(w,a?void 0:{imageOrientation:"flipY"});if(n&&!a){t||(t=new OffscreenCanvas(256,256));const m=t.getContext("2d");if(!m)throw new Error('Offscreencanvas.getContext("2d") error!');return m.drawImage(h,0,0),m.filter=n,await createImageBitmap(t)}if(!a)return h;t||(t=new OffscreenCanvas(256,256));const i=t.getContext("2d");if(!i)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:g,height:p}=t;return i.drawImage(h,0,0),i.rect(0,0,g,p),i.strokeStyle="#00FFFF",i.font="20px Arial",i.stroke(),i.fillStyle="#FF4444",i.fillText("".concat(f[0]),10,30),i.fillStyle="#44FF44",i.fillText("".concat(f[1]),10,55),i.fillStyle="#66AAFF",i.fillText("".concat(f[2]),10,80),await createImageBitmap(t,{imageOrientation:"flipY"})}const d=new Map;self.onmessage=async f=>{var i;const{id:e,tileNo:a,url:n,debug:o,filter:w,abort:h}=f.data;if(h){(i=d.get(e))==null||i.abort(),d.delete(e),self.postMessage({id:e,error:!0});return}try{const g=new s(n,{cache:"force-cache",mode:"cors"});d.set(e,g);const p=await x(a,g,o,w);self.postMessage({id:e,bitmap:p},[p])}catch(g){self.postMessage({id:e,error:!0})}finally{d.delete(e)}}})();
